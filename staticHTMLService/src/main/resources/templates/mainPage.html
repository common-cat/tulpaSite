<!DOCTYPE html>
<!--导入thymeleaf的名称空间-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>TULPA花名册</title>
</head>

<body>
    <script src="/src/js/vue_.js"></script>
    <script src="/src/js/login.js"></script>
    <script src="/src/js/main.js"></script>
    <script>
        alert("此版本为alpha版本,请向开发者反映该版本的bug(common-cat@protonmail.com),该版本注册的花名册会保留到稳定版。")
        if(isPhone()){
            loadStyle("/src/css/main-phone.css");
            loadStyle("/src/css/index-phone.css");
        }else{
            loadStyle("/src/css/main.css");
            loadStyle("/src/css/index.css");
        }
    </script>
    <header>
        <div id="header">
            <div id="user" :class="{display: hidden}">
                <img class="userIcon" id="headIcon" v-bind:src="imgSrc">
            </div>
            <div id="login" class="button" @click="login_">
                登录
            </div>
            <div id="signin" class="button" @click="signin">
                注册
            </div>
            <div id="logout" class="button" @click="logout">
                登出
            </div>
            <div id="login_" class="button" @click="info">{{login}}</div>
            <div id="login__" @click="flushLog"></div>
            <div class="vue" id="logout_" @click="logout">

            </div>
        </div>
    </header>
    <script>
        var headerApp = Vue.createApp(
            {
                data() {
                    return {
                        login: "未登录",
                        imgSrc: "",
                        isLogin: false,
                        hidden: true
                    }
                },
                methods: {
                    login_() {
                        window.open("/static/login");
                    },
                    signin() {
                        window.open("/static/signin");
                    },
                    logout() {
                        setSessionID("");
                        setID("");
                        this.isLogin = false;
                        flushLog();
                    },
                    flushLog() {
                        if (getID() == ""||getID() == null) {
                            this.login = "未登录";
                            this.isLogin=false;
                        } else {
                            this.isLogin=true;
                            this.login = "欢迎" + getID() + "|设置";
                        }
                    }
                    ,
                    info() {
                        if (this.isLogin) {
                            window.open("/static/private/" + getID());
                        } else {
                            window.open("/static/login");
                        }
                    }
                    ,
                    connecting() {
                        alert("联系QQ:2145697048(喵喵)")
                    }
                }
            }
        );
        headerApp.mount("#header");
        function flushLog() {
            ajax = new XMLHttpRequest();
            ajax.open("POST", "/login/sessionID/");
            ajax.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            ajax.onreadystatechange = function () {
                if (ajax.readyState == 4) { 
                    if(ajax.responseText=="401"){
                        setID("");
                    }else{
                        setID(ajax.responseText);
                    }
                    document.getElementById("login__").click();
                }
            }
            ajax.send("sessionID=" + getSessionID());
        }
        window.onfocus = function () {
            flushLog();
        }
    </script>
    <h1 class="title" id="mainTitle">
        TULPA花名册
    </h1>
    <div class="contents" id="searchBind">
        <input id="search" v-model="searchdata" type="text" @keyup.enter.native="search()">
    </div>
    <div class="contents" id="randomPages">
        <hr>
        <div class="button" id="randomPagesButton" @click="random()">获取随机页面列表</div>
        <div class="contents"></div>
        <items v-for="item in randomPages" :tulpas="item.tulpas" :hosts="item.hosts" :introduction="item.introduction"
            :herf="herf"  @page_="page_(item)">
        </items>
        <div id="reflushP" @click="flush()"></div>
    </div>
    <div id="create" class="button">
        <div @click="create_" id="create">点击这里编辑你自己的页面</div>
    </div>
    <script>

        var ajax = new XMLHttpRequest()
        var app = Vue.createApp(
            {
                data() {
                    return {
                        searchdata: "搜索",
                    }
                },
                methods: {
                    search() {
                        window.open("/static/search" + "?" + "q=" + this.searchdata);
                    }
                    //上传搜索的内容
                }
            }
        );
        app.mount("#searchBind");
        var app1 = Vue.createApp(
            {
                methods: {
                    data() {
                        return {

                        }
                    },
                    create_() {

                        window.open("/static/create");
                    }
                }
            }
        );
        var pages = 4;
        app1.mount("#create");
        app2 = Vue.createApp({
            data() {
                return {
                    randomPages: []
                }
            },
            methods: {
                random() {
                    console.log("random");
                    ajax.open("GET", "/mainpage/random/" + pages)
                    ajax.onreadystatechange = function () {
                        if (ajax.readyState == 4) {
                            console.log("rand:"+ajax.responseText)
                            window.p = JSON.parse(ajax.responseText);
                            document.getElementById("reflushP").click();
                        }
                    }
                    ajax.send();
                },
                flush() {
                    this.randomPages = window.p;
                }
                ,
                page_(page){
                    window.open("/static/page/"+page.ID);
                    //todo
                }
            }
        });
        app2.component('items', {
            template:
                `<div class="page_"  v-on:click="$emit('page_')">host:{{hosts}}<div class="bold"><br>tulpas:{{tulpas}}<hr></div>简介：{{introduction}}</div>`
            ,
            props: ["tulpas", "hosts", "hosts", "introduction"]
            , emits: ['page_']
        });
        app2.mount("#randomPages")
        //document.getElementById("randomPagesButton").click();
    </script>
</body>

</html>